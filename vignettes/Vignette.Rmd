---
title: 'abmR: An R Package for Agent-based Model Analysis of Large-scale Movements
  Across Taxa'
author: "Benjamin Gochanour, Javier Fernandez Lopez, Andrea Contina"
date: '`r Sys.Date()`'
output:
  md_document:
    variant: markdown_github
    #theme: journal
    #keep_rd: yes
  html_document:
    toc: yes
    toc_float: yes
    theme: journal
    number_sections: true
  pdf_document:
    toc: yes
warnings: no
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",warning=FALSE,message=FALSE
)
```

# Getting Started

## Installation

To use `abmR`, you must first install it from Github using `devtools` 
and load the library:
```{r}
# devtools: install_github("bgoch5/abmr")
# If install gives errors, try running the following:
# Sys.setenv(R_REMOTES_NO_ERRORS_FROM_WARNINGS="true")
library(abmr,quietly=TRUE,warn.conflicts=FALSE)
```

While this package is still in development, it will be updated frequently, so please
be sure to re-install frequently. Installing `abmr` will also automaticaly install its dependencies, if you don't already have them installed. These include `raster`, `sp`, `rgdal`, `table1`, `googledrive`, `swfscMisc`, `geosphere`, `kableExtra`, and `gtsummary`, and `ggplot`.

## Requirements for Environmental Data Rasters and Species objects

The modeling functions discussed below require several input objects to work, which
we will discuss here.

### Environmental raster stack

Example data that will be used in this Vignette and other package documentation can
be downloaded using `get_ex_data()`. This function will download to your hard drive
(to a location specified by your current working directory) the below
NDVI raster files, totaling approximately 620 MB. The first time you use this function, you will be directed to your browser and required to sign in to your Google account to connect to the Tidyverse API. If you use the function a second time, you may simply follow the prompts and enter a number corresponding to the previous accounts listed.

```{r}
# get_ex_data()
```

Once you have the data downloaded, you must read it into R using commands like the following.
You may instead use your own environmental raster data - NDVI or otherwise - and read it into
R in a similar way.

```{r}
ndvi_raster_EU=stack("C:/Users/BGOCHANOUR/Documents/GitHub/move-model/NDVI_2013_Europe.gri")
ndvi_raster_EU_composite=raster("C:/Users/BGOCHANOUR/Documents/GitHub/move-model/NDVI_2013_Europe_composite.gri")
```

We can now quickly examine our raster data to see if it read in correctly.

The first raster is a 27-layer stack (of which we will plot the first four layers), and the second is a composite raster formed by taking the mean of all layers.

```{r}
plot(ndvi_raster_EU[[1:4]]) # First four layers of 27 layer RasterStack
plot(ndvi_raster_EU_composite)
```

### Species object

This object will be constructed with the function `as.species`, and contains information on origin longitude (x) and latitude (y) as well as two morphological parameters, `p1` and `p2`. Use `?as.species` for more details.

```{r}
EU.pop = as.species(x=10,
                    y=50, 
                    morphpar1=24, 
                    morphpar1mean=16,
                    morphpar1sd=5,
                    morphpar1sign="Pos", 
                    morphpar2=12,
                    morphpar2mean=9,
                    morphpar2sd=3,
                    morphpar2sign="Neg")
```


# Running Agent-based models

`abmR` has two functions for modeling animal movement: `moveSIM` and `energySIM`.
Both `moveSIM` and `energySIM` will output two things: (1) a dataframe of results (`$results`) and (2) a summary table of input parameters used (`$run_params`). For more details on how each function works, please see the documentation by using ?moveSIM or ?energySIM.


## `moveSIM`

First, we will look at `moveSIM()` the more basic function that....

```{r,cache=TRUE}
set.seed(1)
EU.move=moveSIM(replicates = 50, 
               days=27,
               env_rast=ndvi_raster_EU,
               search_radius=250,
               sigma=0.1,
               dest_x=999,
               dest_y=999,
               mot_x=0.7,
               mot_y=0.7,
               modeled_species=EU.pop,
               optimum = 0.7,
               direction="S",
               write_results=F,
               single_rast=F,
               mortality = T,
               n_failures = 3,
               fail_thresh = 0.50)

```

We can simply view our results in the console by typing `NA.move` or `EU.move`. However,
we have created the function `tidy_results()` to provide cleaner output. Simply supply your
moveSIM() or energySIM() output and specify `type`="results" or `type`="run_params", depending on which portion of your output you'd like to display.

Let's examine our European `moveSIM()` output. Here, we view just the first 10 rows.

```{r}
tidy_results(EU.move,
             type="results",
             nrows=10)
tidy_results(EU.move,
             type="run_params")
```

## `energySIM`

Next, we turn our attention to `energySIM()`, the more advanced function that
does XXXX additional things...

```{r, cache=TRUE}
EU.energy = energySIM(replicates = 50, 
                      days=27, 
                      env_rast=ndvi_raster_EU,
                      search_radius=250,
                      sigma=0.1,
                      dest_x=999,
                      dest_y=999, 
                      mot_x=0.7,
                      mot_y=0.7,
                      modeled_species=EU.pop,
                      optimum_lo = 0.65,
                      optimum_hi=0.75,
                      init_energy=100,
                      direction="S",
                      write_results=F,
                      single_rast=F,
                      mortality = T)
```

The `tidy_results` function will also work on `energySIM()` output. Here, we view just the first
10 rows of our results.

```{r}
tidy_results(EU.energy,
             type="results",
             nrows=10)
tidy_results(EU.energy,
             type="run_params")
```


# Visualizing/Summarizing Results

The output from `moveSIM` and `energySIM` are simple dataframes, so one may easily
visualize their results using custom codes. However, we have provided `moveVIZ` and `energyVIZ`,
respectively, to provide pre-prepared solutions for visualizing and summarizing your
movement simulation results.

### Movement tracks

```{r}
moveVIZ(EU.move, 
        type="plot",
        title="moveSIM European results")
energyVIZ(EU.energy,
          type="plot",
          title="EnergySIM European results")
```

### Summary table

```{r}
moveVIZ(EU.move,
        type="summary_table")
energyVIZ(EU.energy,
          type="summary_table")
```

The next two types of output are available only for `energySIM()` output.

### Stratified tables

```{r}
energyVIZ(EU.energy,
          type="strat_table")
```

### Gradient plots

```{r}
energyVIZ(EU.energy,
          type="gradient")
```

# Getting Help

Need help? Have suggestions to make `abmR` better? If so, please open an issue or
pull request on Github (https://github.com/bgoch5/abmr), or drop me an email at ben.gochanour\@ou.edu.
